<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.qq4j.mapper.QQMessagesMapper">

  <select id="fetchAnswersByMessage" resultType="QQMessage">
    select
        qq_messages.answer
    ,   count(qq_messages.message_id) as resultCount
    from
        qq_messages
    where
        qq_messages.message = #{message}
    and qq_messages.qq = #{qq}
    and qq_messages.UNKNOWN = 0
    and (
            qq_messages.owner = #{owner}
        or  qq_messages.PRIVATABLE = 0
    )
    group by qq_messages.answer
    order by resultCount desc
  </select>
  
  <select id="fetchAnswersByIndex" resultType="QQMessage">
    select
        qq_messages.answer
    ,   count(qq_messages.message_id) as resultCount
    from
        qq_messages
            join
        qq_index ON qq_index.message_id = qq_messages.message_id
    where
        word in 
        <foreach item="item" index="index" collection="words"
            open="(" separator="," close=")">
                #{item}
        </foreach>
    and qq_messages.UNKNOWN = 0
    and (
           qq_messages.owner = #{owner}
        or qq_messages.PRIVATABLE = 0
    )
    group by qq_messages.answer
    order by resultCount desc
  </select>
  
  <select id="getNewMessageId" resultType="string">
      SELECT 
        1
      FROM 
        DUAL
  </select>

  <insert id="insertMessage" useGeneratedKeys="true">
    insert into qq_messages (
        qq
    ,   owner
    ,   message
    ,   answer
    ,   privatable
    ,   unknown
    ) values (
        #{qq}
    ,   #{owner}
    ,   #{message}
    ,   #{answer}
    ,   #{privatable}
    ,   #{unknown}
    )
    <selectKey resultType="string" keyProperty="messageId" order="AFTER">
        SELECT @@IDENTITY
    </selectKey>
  </insert>

  <insert id="insertIndex" useGeneratedKeys="true">
    insert into qq_index (
        word
    ,   message_id
    ) values (
        #{word}
    ,   #{message.messageId}
    )
  </insert>

    <select id="countMessages" resultType="int">
        select
            count(*)
        from
            qq_messages
        where
            qq = #{qq}
        and del_flg = 0
    </select>

    <select id="fetchMessages" resultType="QQMessage">
        select
            cast(message_id as CHAR )  as messageId
        ,   message
        ,   answer
        ,   owner
        ,   qq
        ,   privatable
        ,   unknown
        from
            qq_messages
        where
            qq = #{qq}
        and del_flg = 0
        limit #{start}, #{end}
    </select>

    <select id="fetchMessage" resultType="QQMessage">
        select
            cast(message_id as CHAR )  as messageId
        ,   message
        ,   answer
        ,   owner
        ,   qq
        ,   privatable
        ,   unknown
        from
            qq_messages
        where
            message_id = #{messageId}
        and del_flg = 0
    </select>
    
    <update id="updateMessage" >
        update
            qq_messages
        set
            answer = #{answer}
        ,   privatable = #{privatable}
        ,   unknown = #{unknown}
        where
            message_id = #{messageId}
        and del_flg = 0
    </update>

    <select id="fetchIndexes" resultType="String">
        select
            word
        from
            qq_index
        where
            message_id = #{messageId}
        and del_flg = 0
    </select>
</mapper>