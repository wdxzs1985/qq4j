<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.qq4j.mapper.QQMessagesMapper">

  <select id="fetchAnswersByMessage" resultType="string">
    select
        answer
    from
        QQ_MESSAGES
    where
        message = #{message}
    and qq = #{qq}
    and (
            (owner = #{owner} and public_flg = 0)
        or public_flg = 1
    )
  </select>
  
  <select id="fetchAnswersByIndex" resultType="string">
    select
        answer
    from
        qq_messages
            join
        qq_index ON qq_index.message_id = qq_messages.id
    where
        word in 
        <foreach item="item" index="index" collection="words"
            open="(" separator="," close=")">
                #{item}
        </foreach>
    and (
            (owner = #{owner} and public_flg = 0)
        or public_flg = 1
    )
    order by count(message_id) desc
  </select>

  <insert id="insertMessage" useGeneratedKeys="true">
    insert into qq_messages (
        qq
    ,   owner
    ,   message
    ,   answer
    ) values (
        #{qq}
    ,   #{owner}
    ,   #{message}
    ,   #{answer}
    )
    <selectKey resultType="string" keyProperty="message_id" order="AFTER">
        SELECT @@IDENTITY
    </selectKey>
  </insert>

  <insert id="insertIndex" useGeneratedKeys="true">
    insert into qq_index (
        word
    ,   message_id
    ) values (
        #{word}
    ,   #{message.message_id}
    )
  </insert>

</mapper>